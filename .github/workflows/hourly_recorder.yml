# File: .github/workflows/test_record_aqi.yml
# Purpose: Scheduled run and manual smoke-test for scripts/record_aqi.js
# This version avoids `npm ci` failures by choosing the appropriate install command.

name: Test Record AQI

on:
  schedule:
    # Attempt to run every 2 minutes (may be subject to GitHub schedule limits)
    - cron: '*/2 * * * *'
  workflow_dispatch: {}

jobs:
  run_once:
    name: Run record_aqi.js once
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (robust)
        run: |
          set -e
          if [ -f package-lock.json ]; then
            echo "package-lock.json found -> using npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "package.json found, no lockfile -> using npm install"
            npm install --no-audit --no-fund
          else
            echo "No package.json -> installing minimal runtime deps"
            npm install axios firebase-admin --no-audit --no-fund
          fi

      - name: Run record script
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          USER_UID: ${{ secrets.USER_UID }}
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: |
          echo "Running record_aqi.js at $(date -u)"
          node scripts/record_aqi.js

  smoke_test_loop:
    name: Manual smoke-test: loop every 2 minutes (trigger via 'Run workflow' in Actions)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (robust)
        run: |
          set -e
          if [ -f package-lock.json ]; then
            echo "package-lock.json found -> using npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "package.json found, no lockfile -> using npm install"
            npm install --no-audit --no-fund
          else
            echo "No package.json -> installing minimal runtime deps"
            npm install axios firebase-admin --no-audit --no-fund
          fi

      - name: Run in 2-minute loop (5 iterations -> ~10 minutes)
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          USER_UID: ${{ secrets.USER_UID }}
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: |
          echo "Starting smoke-test loop at $(date -u)"
          ITERATIONS=5
          for i in $(seq 1 $ITERATIONS); do
            echo "Iteration $i at $(date -u)"
            node scripts/record_aqi.js || echo "Script exited with non-zero code (iteration $i)"
            if [ "$i" -lt "$ITERATIONS" ]; then
              echo "Sleeping 120s..."
              sleep 120
            fi
          done
          echo "Smoke-test loop complete at $(date -u)"
