# File: .github/workflows/test_record_aqi.yml
# Purpose: Scheduled run and manual smoke-test for scripts/record_aqi.js
# NOTE: GitHub Scheduled workflows use cron syntax. Some GitHub environments may not reliably run schedules below 5-minute granularity.
#       The smoke-test job lets you manually run the script in a 2-minute loop for quick verification.

name: Test Record AQI

on:
  schedule:
    # Attempt to run every 2 minutes. If your GitHub account/plan/enforcement disallows <5m scheduling,
    # this schedule may not run exactly every 2 minutes. See notes below.
    - cron: '*/2 * * * *'
  workflow_dispatch: {}

jobs:
  run_once:
    name: Run record_aqi.js once
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (if any) or required packages
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          else
            # No package.json â€” install required packages locally for the job
            npm install axios firebase-admin
          fi

      - name: Run record script
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          USER_UID: ${{ secrets.USER_UID }}
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: |
          echo "Running record_aqi.js at $(date -u)"
          node scripts/record_aqi.js

  smoke_test_loop:
    name: Manual smoke-test: loop every 2 minutes (trigger via 'Run workflow' in Actions)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (if any) or required packages
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          else
            npm install axios firebase-admin
          fi

      - name: Run in 2-minute loop (5 iterations -> ~10 minutes)
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          USER_UID: ${{ secrets.USER_UID }}
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}
        run: |
          echo "Starting smoke-test loop at $(date -u)"
          ITERATIONS=5
          for i in $(seq 1 $ITERATIONS); do
            echo "Iteration $i at $(date -u)"
            node scripts/record_aqi.js || echo "Script exited with non-zero code (iteration $i)"
            if [ "$i" -lt "$ITERATIONS" ]; then
              echo "Sleeping 120s..."
              sleep 120
            fi
          done
          echo "Smoke-test loop complete at $(date -u)"
